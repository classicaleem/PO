@model PurchaseOrderViewModel
@{
    ViewData["Title"] = "Edit Purchase Order";
}

<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-edit me-3"></i>Edit Purchase Order</h1>
            <p class="mb-0 opacity-75">@Model.InternalPoCode</p>
        </div>
        <a asp-action="Index" class="btn btn-light">
            <i class="fas fa-arrow-left me-2"></i>Back to List
        </a>
    </div>
</div>

<form asp-action="Edit" method="post" id="poForm">
    <input type="hidden" asp-for="PoId" />
    <input type="hidden" asp-for="InternalPoCode" />
    <div asp-validation-summary="All" class="alert alert-danger" style="display:none;"></div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>PO Header</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label asp-for="InternalPoCode" class="form-label fw-semibold">Internal PO Code</label>
                            <input value="@Model.InternalPoCode" class="form-control" readonly style="background-color: #e9ecef;" />
                        </div>
                        
                        <div class="col-md-8">
                            <label asp-for="PoNumber" class="form-label fw-semibold">PO Number *</label>
                            <input asp-for="PoNumber" class="form-control" />
                            <span asp-validation-for="PoNumber" class="text-danger"></span>
                        </div>

                        <div class="col-12">
                            <label asp-for="CustomerId" class="form-label fw-semibold">Customer *</label>
                            <select asp-for="CustomerId" asp-items="Model.Customers" class="form-select select2-customer" id="customerSelect">
                                <option value="">-- Select Customer --</option>
                            </select>
                            <span asp-validation-for="CustomerId" class="text-danger"></span>
                        </div>

                        <div class="col-12" id="customerDetailsDiv" @(Model.CustomerId > 0 ? "" : "style=display:none;")>
                            <label class="form-label fw-semibold">Customer Details</label>
                            <textarea id="customerDetails" class="form-control" rows="3" readonly style="background-color: #f8f9fa;">@(Model.CustomerName != null ? Model.CustomerName + "\n" + Model.CustomerAddress + "\nGST: " + (Model.CustomerGstNumber ?? "N/A") : "")</textarea>
                        </div>

                        <div class="col-md-4">
                            <label asp-for="PoDate" class="form-label fw-semibold">PO Date *</label>
                            <input asp-for="PoDate" class="form-control" type="date" />
                        </div>

                        <div class="col-md-4">
                            <label asp-for="StartDate" class="form-label fw-semibold">Start Date</label>
                            <input asp-for="StartDate" class="form-control" type="date" />
                        </div>

                        <div class="col-md-4">
                            <label asp-for="EndDate" class="form-label fw-semibold">End Date</label>
                            <input asp-for="EndDate" class="form-control" type="date" />
                        </div>

                        <div class="col-12">
                            <div class="form-check">
                                <input asp-for="IsCompleted" class="form-check-input" />
                                <label asp-for="IsCompleted" class="form-check-label">Mark as Completed</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>PO Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>Total Items:</span>
                        <span id="totalItems" class="fw-bold">@Model.Items.Count</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="h5 mb-0">PO Amount:</span>
                        <span id="poAmount" class="h4 mb-0 text-primary">₹@Model.PoAmount.ToString("N2")</span>
                    </div>
                    <input type="hidden" asp-for="PoAmount" id="poAmountInput" />
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <button type="submit" class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-save me-2"></i>Update Purchase Order
                    </button>
                    <a asp-action="Index" class="btn btn-outline-secondary w-100">Cancel</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Items Section -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>PO Items</h5>
            <button type="button" class="btn btn-sm btn-primary" id="addItemBtn">
                <i class="fas fa-plus me-1"></i>Add Item
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="itemsTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 40%;">Item Description *</th>
                            <th style="width: 15%;">Quantity *</th>
                            <th style="width: 15%;">Unit Price *</th>
                            <th style="width: 15%;">Line Total</th>
                            <th style="width: 10%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        @for (int i = 0; i < Model.Items.Count; i++)
                        {
                            var item = Model.Items[i];
                            <tr class="item-row">
                                <td class="text-center line-number">@(i + 1)</td>
                                <td>
                                    <input type="hidden" name="Items[@i].PoItemId" value="@item.PoItemId" />
                                    <input type="hidden" name="Items[@i].LineNumber" value="@(i + 1)" />
                                    <input type="text" name="Items[@i].ItemDescription" value="@item.ItemDescription" 
                                           class="form-control item-description" />
                                </td>
                                <td>
                                    <input type="number" name="Items[@i].Quantity" value="@item.Quantity" 
                                           class="form-control item-quantity" min="1" />
                                </td>
                                <td>
                                    <input type="number" name="Items[@i].UnitPrice" value="@item.UnitPrice" 
                                           class="form-control item-price" min="0.01" step="0.01" />
                                </td>
                                <td>
                                    <input type="text" class="form-control item-total" value="@item.LineTotal.ToString("N2")" 
                                           readonly style="background-color: #e9ecef;" />
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            $('.select2-customer').select2({ theme: 'bootstrap-5', placeholder: 'Search...', allowClear: true });

            $('#customerSelect').on('change', function() {
                var customerId = $(this).val();
                if (customerId) {
                    $.get('@Url.Action("GetCustomerDetails", "Customers")', { id: customerId }, function(data) {
                        $('#customerDetailsDiv').show();
                        $('#customerDetails').val(data.customerName + '\n' + data.address + '\nGST: ' + (data.gstNumber || 'N/A'));
                    });
                } else {
                    $('#customerDetailsDiv').hide();
                }
            });

            function calculateTotals() {
                var totalAmount = 0, itemCount = 0;
                $('#itemsBody tr.item-row').each(function(index) {
                    var qty = parseFloat($(this).find('.item-quantity').val()) || 0;
                    var price = parseFloat($(this).find('.item-price').val()) || 0;
                    var lineTotal = qty * price;
                    $(this).find('.item-total').val(lineTotal.toFixed(2));
                    if ($(this).find('.item-description').val().trim() !== '') {
                        totalAmount += lineTotal;
                        if (qty > 0) itemCount++;
                    }
                    $(this).find('.line-number').text(index + 1);
                    $(this).find('input[name*="LineNumber"]').val(index + 1);
                    $(this).find('input').each(function() {
                        var name = $(this).attr('name');
                        if (name) $(this).attr('name', name.replace(/\[\d+\]/, '[' + index + ']'));
                    });
                });
                $('#totalItems').text(itemCount);
                $('#poAmount').text('₹' + totalAmount.toFixed(2));
                $('#poAmountInput').val(totalAmount.toFixed(2));
            }

            $(document).on('input', '.item-quantity, .item-price', calculateTotals);

            $('#addItemBtn').on('click', function() {
                var rowCount = $('#itemsBody tr.item-row').length;
                if (rowCount >= 10) { alert('Maximum 10 items'); return; }
                var newRow = `<tr class="item-row"><td class="text-center line-number">${rowCount+1}</td><td><input type="hidden" name="Items[${rowCount}].PoItemId" value="0" /><input type="hidden" name="Items[${rowCount}].LineNumber" value="${rowCount+1}" /><input type="text" name="Items[${rowCount}].ItemDescription" class="form-control item-description" /></td><td><input type="number" name="Items[${rowCount}].Quantity" class="form-control item-quantity" min="1" /></td><td><input type="number" name="Items[${rowCount}].UnitPrice" class="form-control item-price" min="0.01" step="0.01" /></td><td><input type="text" class="form-control item-total" value="0.00" readonly style="background-color:#e9ecef" /></td><td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger remove-item-btn"><i class="fas fa-times"></i></button></td></tr>`;
                $('#itemsBody').append(newRow);
                calculateTotals();
            });

            $(document).on('click', '.remove-item-btn', function() {
                if ($('#itemsBody tr.item-row').length <= 1) { alert('At least one item required'); return; }
                $(this).closest('tr').remove();
                calculateTotals();
            });

            calculateTotals();
        });
    </script>
}
